<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soda Tavern - Idle RPG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        .damage-popup {
            position: absolute;
            color: red;
            font-weight: bold;
            animation: damageAnimation 1s forwards;
            pointer-events: none;
        }
        
        @keyframes damageAnimation {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }
        
        .progress-bar {
            transition: width 0.3s ease;
        }
        
        .character {
            transition: all 0.2s ease;
        }
        
        .character:hover {
            transform: scale(1.05);
        }
        
        .character-attack {
            animation: attackAnimation 0.3s ease;
        }
        
        @keyframes attackAnimation {
            0% { transform: translateX(0); }
            50% { transform: translateX(10px); }
            100% { transform: translateX(0); }
        }
        
        .enemy-attack {
            animation: enemyAttackAnimation 0.3s ease;
        }
        
        @keyframes enemyAttackAnimation {
            0% { transform: translateX(0); }
            50% { transform: translateX(-10px); }
            100% { transform: translateX(0); }
        }
        
        .shake {
            animation: shake 0.5s;
        }
        
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }
        
        .pixel-art {
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-mono min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-md">
        <!-- Game Header -->
        <header class="flex justify-between items-center mb-6 fade-in">
            <div class="flex items-center">
                <i class="fas fa-beer text-yellow-400 text-2xl mr-2"></i>
                <h1 class="text-2xl font-bold">Soda Tavern</h1>
            </div>
            <div class="flex items-center space-x-4">
                <div class="bg-gray-800 px-3 py-1 rounded-lg flex items-center">
                    <i class="fas fa-coins text-yellow-400 mr-1"></i>
                    <span id="gold">100</span>
                </div>
                <div class="bg-gray-800 px-3 py-1 rounded-lg flex items-center">
                    <i class="fas fa-gem text-blue-400 mr-1"></i>
                    <span id="gems">5</span>
                </div>
            </div>
        </header>

        <!-- Main Game Area -->
        <main>
            <!-- Tavern Tab -->
            <div id="tavern-tab" class="mb-6 slide-in">
                <div class="bg-gray-800 rounded-lg p-4 mb-4">
                    <h2 class="text-xl font-bold mb-3 flex items-center">
                        <i class="fas fa-beer-mug-empty mr-2 text-yellow-400"></i> Tavern
                    </h2>
                    <p class="text-gray-300 mb-4">Recruit adventurers to fight for you while you're away!</p>
                    
                    <div class="grid grid-cols-4 gap-3 mb-4">
                        <div class="bg-gray-700 p-2 rounded-lg text-center cursor-pointer hover:bg-gray-600 transition character" onclick="recruitCharacter('warrior')">
                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='30' r='20' fill='%234169E1'/%3E%3Crect x='30' y='50' width='40' height='40' fill='%234169E1'/%3E%3Crect x='20' y='55' width='60' height='10' fill='%234169E1'/%3E%3Ccircle cx='40' cy='25' r='5' fill='white'/%3E%3Ccircle cx='60' cy='25' r='5' fill='white'/%3E%3C/svg%3E" alt="Warrior" class="w-16 h-16 mx-auto mb-1 pixel-art">
                            <div class="text-xs">Warrior</div>
                            <div class="text-yellow-400 text-xs">50g</div>
                        </div>
                        <div class="bg-gray-700 p-2 rounded-lg text-center cursor-pointer hover:bg-gray-600 transition character" onclick="recruitCharacter('mage')">
                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='30' r='20' fill='%239370DB'/%3E%3Crect x='35' y='50' width='30' height='40' fill='%239370DB'/%3E%3Ccircle cx='40' cy='25' r='5' fill='white'/%3E%3Ccircle cx='60' cy='25' r='5' fill='white'/%3E%3C/svg%3E" alt="Mage" class="w-16 h-16 mx-auto mb-1 pixel-art">
                            <div class="text-xs">Mage</div>
                            <div class="text-yellow-400 text-xs">75g</div>
                        </div>
                        <div class="bg-gray-700 p-2 rounded-lg text-center cursor-pointer hover:bg-gray-600 transition character" onclick="recruitCharacter('thief')">
                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='30' r='20' fill='%232F4F4F'/%3E%3Crect x='30' y='50' width='40' height='40' fill='%232F4F4F'/%3E%3Ccircle cx='40' cy='25' r='5' fill='white'/%3E%3Ccircle cx='60' cy='25' r='5' fill='white'/%3E%3C/svg%3E" alt="Thief" class="w-16 h-16 mx-auto mb-1 pixel-art">
                            <div class="text-xs">Thief</div>
                            <div class="text-yellow-400 text-xs">60g</div>
                        </div>
                        <div class="bg-gray-700 p-2 rounded-lg text-center cursor-pointer hover:bg-gray-600 transition character" onclick="recruitCharacter('medic')">
                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='30' r='20' fill='%23FF6347'/%3E%3Crect x='35' y='50' width='30' height='40' fill='%23FF6347'/%3E%3Ccircle cx='40' cy='25' r='5' fill='white'/%3E%3Ccircle cx='60' cy='25' r='5' fill='white'/%3E%3C/svg%3E" alt="Medic" class="w-16 h-16 mx-auto mb-1 pixel-art">
                            <div class="text-xs">Medic</div>
                            <div class="text-yellow-400 text-xs">70g</div>
                        </div>
                    </div>
                    
                    <button id="auto-recruit-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg transition flex items-center justify-center" onclick="toggleAutoRecruit()">
                        <i class="fas fa-robot mr-2"></i> Auto-Recruit: Off
                    </button>
                </div>
            </div>

            <!-- Battle Tab -->
            <div id="battle-tab" class="mb-6">
                <div class="bg-gray-800 rounded-lg p-4">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-xl font-bold flex items-center">
                            <i class="fas fa-swords mr-2 text-red-400"></i> Battle
                        </h2>
                        <div class="text-sm">
                            Floor: <span id="floor">1</span>
                        </div>
                    </div>
                    
                    <!-- Enemy Display -->
                    <div class="bg-gray-700 rounded-lg p-4 mb-4 relative" id="enemy-container">
                        <div class="flex justify-center mb-2">
                            <img src="https://i.imgur.com/5jQZQ9L.png" alt="Enemy" class="w-24 h-24 pixel-art" id="enemy-image">
                        </div>
                        <div class="text-center font-bold mb-1" id="enemy-name">Goblin</div>
                        <div class="h-2 bg-gray-600 rounded-full mb-1">
                            <div class="h-full bg-red-500 rounded-full progress-bar" id="enemy-health-bar" style="width: 100%"></div>
                        </div>
                        <div class="text-xs text-right" id="enemy-health">100/100</div>
                    </div>
                    
                    <!-- Party Display -->
                    <div class="grid grid-cols-5 gap-2 mb-4" id="party-container">
                        <!-- Party slots will be added here dynamically -->
                        <div class="bg-gray-700 rounded-lg p-1 text-center party-slot empty-slot" data-slot="0" onclick="managePartySlot(0)">
                            <div class="w-12 h-12 mx-auto mb-1 flex items-center justify-center text-gray-500">
                                <i class="fas fa-plus"></i>
                            </div>
                        </div>
                        <div class="bg-gray-700 rounded-lg p-1 text-center party-slot empty-slot" data-slot="1" onclick="managePartySlot(1)">
                            <div class="w-12 h-12 mx-auto mb-1 flex items-center justify-center text-gray-500">
                                <i class="fas fa-plus"></i>
                            </div>
                        </div>
                        <div class="bg-gray-700 rounded-lg p-1 text-center party-slot empty-slot" data-slot="2" onclick="managePartySlot(2)">
                            <div class="w-12 h-12 mx-auto mb-1 flex items-center justify-center text-gray-500">
                                <i class="fas fa-plus"></i>
                            </div>
                        </div>
                        <div class="bg-gray-700 rounded-lg p-1 text-center party-slot empty-slot" data-slot="3" onclick="managePartySlot(3)">
                            <div class="w-12 h-12 mx-auto mb-1 flex items-center justify-center text-gray-500">
                                <i class="fas fa-plus"></i>
                            </div>
                        </div>
                        <div class="bg-gray-700 rounded-lg p-1 text-center party-slot empty-slot" data-slot="4" onclick="managePartySlot(4)">
                            <div class="w-12 h-12 mx-auto mb-1 flex items-center justify-center text-gray-500">
                                <i class="fas fa-plus"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex space-x-2">
                        <button id="battle-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg transition" onclick="startBattle()">
                            <i class="fas fa-play mr-1"></i> Start Battle
                        </button>
                        <button id="auto-battle-btn" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg transition" onclick="toggleAutoBattle()">
                            <i class="fas fa-robot mr-1"></i> Auto: Off
                        </button>
                    </div>
                </div>
            </div>

            <!-- Inventory Tab -->
            <div id="inventory-tab" class="mb-6">
                <div class="bg-gray-800 rounded-lg p-4">
                    <h2 class="text-xl font-bold mb-3 flex items-center">
                        <i class="fas fa-backpack mr-2 text-blue-400"></i> Inventory
                    </h2>
                    
                    <div class="grid grid-cols-4 gap-2 mb-4" id="inventory-container">
                        <!-- Items will be added here dynamically -->
                        <div class="bg-gray-700 p-2 rounded-lg text-center cursor-pointer hover:bg-gray-600 transition">
                            <div class="w-12 h-12 mx-auto mb-1 flex items-center justify-center text-gray-500">
                                <i class="fas fa-plus"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-sm text-gray-400">
                        <i class="fas fa-info-circle mr-1"></i> Items are automatically equipped to your party
                    </div>
                </div>
            </div>

            <!-- Upgrades Tab -->
            <div id="upgrades-tab">
                <div class="bg-gray-800 rounded-lg p-4">
                    <h2 class="text-xl font-bold mb-3 flex items-center">
                        <i class="fas fa-arrow-up mr-2 text-green-400"></i> Upgrades
                    </h2>
                    
                    <div class="space-y-3">
                        <div class="bg-gray-700 rounded-lg p-3 flex justify-between items-center">
                            <div>
                                <h3 class="font-bold">Tavern Capacity</h3>
                                <p class="text-sm text-gray-300">Increase max adventurers from <span id="current-capacity">5</span> to <span id="next-capacity">10</span></p>
                            </div>
                            <button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-lg transition" onclick="buyUpgrade('capacity')">
                                500g
                            </button>
                        </div>
                        
                        <div class="bg-gray-700 rounded-lg p-3 flex justify-between items-center">
                            <div>
                                <h3 class="font-bold">Auto-Battle Speed</h3>
                                <p class="text-sm text-gray-300">Increase battle speed by 25%</p>
                            </div>
                            <button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-lg transition" onclick="buyUpgrade('speed')">
                                250g
                            </button>
                        </div>
                        
                        <div class="bg-gray-700 rounded-lg p-3 flex justify-between items-center">
                            <div>
                                <h3 class="font-bold">Gold Find</h3>
                                <p class="text-sm text-gray-300">Increase gold earned by 20%</p>
                            </div>
                            <button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-lg transition" onclick="buyUpgrade('gold')">
                                300g
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Battle Log -->
        <div id="battle-log" class="fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700 p-3 max-h-40 overflow-y-auto hidden">
            <div class="flex justify-between items-center mb-2">
                <h3 class="font-bold">Battle Log</h3>
                <button onclick="toggleBattleLog()" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="log-content" class="text-sm space-y-1"></div>
        </div>
    </div>

    <script>
        // Game State
        const gameState = {
            gold: 100,
            gems: 5,
            floor: 1,
            autoRecruit: false,
            autoBattle: false,
            battleInterval: null,
            recruitInterval: null,
            party: Array(5).fill(null),
            tavern: [],
            inventory: [],
            upgrades: {
                capacity: { level: 1, cost: 500 },
                speed: { level: 1, cost: 250 },
                gold: { level: 1, cost: 300 }
            },
            currentEnemy: null,
            isBattling: false,
            battleSpeed: 1000
        };

        // Character Types
        const characterTypes = {
            warrior: {
                name: "Warrior",
                health: 120,
                maxHealth: 120,
                attack: 15,
                defense: 10,
                cost: 50,
                attackSpeed: 1000,
                dodgeRate: 0.05,
                critChance: 0.1,
                image: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='30' r='20' fill='%234169E1'/%3E%3Crect x='30' y='50' width='40' height='40' fill='%234169E1'/%3E%3Crect x='20' y='55' width='60' height='10' fill='%234169E1'/%3E%3Ccircle cx='40' cy='25' r='5' fill='white'/%3E%3Ccircle cx='60' cy='25' r='5' fill='white'/%3E%3C/svg%3E"
            },
            mage: {
                name: "Mage",
                health: 80,
                maxHealth: 80,
                attack: 25,
                defense: 5,
                cost: 75,
                attackSpeed: 1200,
                dodgeRate: 0.08,
                critChance: 0.15,
                image: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='30' r='20' fill='%239370DB'/%3E%3Crect x='35' y='50' width='30' height='40' fill='%239370DB'/%3E%3Ccircle cx='40' cy='25' r='5' fill='white'/%3E%3Ccircle cx='60' cy='25' r='5' fill='white'/%3E%3C/svg%3E"
            },
            thief: {
                name: "Thief",
                health: 90,
                maxHealth: 90,
                attack: 18,
                defense: 8,
                cost: 60,
                attackSpeed: 800,
                dodgeRate: 0.15,
                critChance: 0.2,
                image: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='30' r='20' fill='%232F4F4F'/%3E%3Crect x='30' y='50' width='40' height='40' fill='%232F4F4F'/%3E%3Ccircle cx='40' cy='25' r='5' fill='white'/%3E%3Ccircle cx='60' cy='25' r='5' fill='white'/%3E%3C/svg%3E"
            },
            medic: {
                name: "Medic",
                health: 100,
                maxHealth: 100,
                attack: 8,
                defense: 6,
                cost: 70,
                attackSpeed: 1500,
                dodgeRate: 0.03,
                critChance: 0.05,
                image: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='30' r='20' fill='%23FF6347'/%3E%3Crect x='35' y='50' width='30' height='40' fill='%23FF6347'/%3E%3Ccircle cx='40' cy='25' r='5' fill='white'/%3E%3Ccircle cx='60' cy='25' r='5' fill='white'/%3E%3C/svg%3E"
            }
        };

        // Enemy Types with levels
        const enemyTypes = [
            { name: "Rat", level: 1, health: 50, maxHealth: 50, attack: 8, defense: 2, image: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='40' fill='%238B4513'/%3E%3Ccircle cx='35' cy='40' r='5' fill='black'/%3E%3Ccircle cx='65' cy='40' r='5' fill='black'/%3E%3Cpath d='M40,65 Q50,75 60,65' stroke='black' stroke-width='3' fill='none'/%3E%3C/svg%3E" },
            { name: "Goblin", level: 2, health: 80, maxHealth: 80, attack: 12, defense: 5, image: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='40' r='25' fill='%23228B22'/%3E%3Crect x='30' y='60' width='40' height='30' fill='%23228B22'/%3E%3Ccircle cx='40' cy='35' r='5' fill='red'/%3E%3Ccircle cx='60' cy='35' r='5' fill='red'/%3E%3Cpath d='M45,50 Q50,55 55,50' stroke='black' stroke-width='2' fill='none'/%3E%3C/svg%3E" },
            { name: "Wolf", level: 3, health: 120, maxHealth: 120, attack: 15, defense: 8, image: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M20,50 Q40,30 60,40 Q80,50 90,60 Q80,70 60,65 Q40,70 20,50' fill='%23808080'/%3E%3Ccircle cx='70' cy='45' r='3' fill='black'/%3E%3Cpath d='M30,45 Q35,40 40,45' stroke='black' stroke-width='2' fill='none'/%3E%3C/svg%3E" },
            { name: "Orc", level: 4, health: 160, maxHealth: 160, attack: 20, defense: 12, image: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='35' r='20' fill='%2332CD32'/%3E%3Crect x='30' y='50' width='40' height='40' fill='%2332CD32'/%3E%3Crect x='20' y='40' width='10' height='30' fill='%238B4513'/%3E%3Crect x='70' y='40' width='10' height='30' fill='%238B4513'/%3E%3Ccircle cx='45' cy='30' r='3' fill='red'/%3E%3Ccircle cx='55' cy='30' r='3' fill='red'/%3E%3C/svg%3E" },
            { name: "Skeleton Knight", level: 5, health: 200, maxHealth: 200, attack: 25, defense: 15, image: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='30' r='15' fill='white'/%3E%3Crect x='35' y='40' width='30' height='40' fill='white'/%3E%3Crect x='25' y='45' width='50' height='5' fill='white'/%3E%3Crect x='30' y='50' width='40' height='30' fill='white'/%3E%3Ccircle cx='45' cy='25' r='2' fill='black'/%3E%3Ccircle cx='55' cy='25' r='2' fill='black'/%3E%3C/svg%3E" },
            { name: "Minotaur", level: 6, health: 250, maxHealth: 250, attack: 30, defense: 18, image: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='30' r='20' fill='%23CD853F'/%3E%3Crect x='30' y='45' width='40' height='40' fill='%23CD853F'/%3E%3Cpath d='M30,30 Q20,20 25,10 Q30,5 35,10 Q40,5 45,10 Q50,5 55,10 Q60,5 65,10 Q70,20 60,30' fill='%23CD853F'/%3E%3Ccircle cx='40' cy='25' r='3' fill='black'/%3E%3Ccircle cx='60' cy='25' r='3' fill='black'/%3E%3C/svg%3E" },
            { name: "Dragon", level: 7, health: 350, maxHealth: 350, attack: 40, defense: 25, image: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M20,50 Q40,30 60,40 Q80,50 90,60 Q80,70 60,65 Q40,70 20,50' fill='%23FF0000'/%3E%3Ccircle cx='70' cy='45' r='5' fill='yellow'/%3E%3Cpath d='M30,45 Q35,40 40,45' stroke='black' stroke-width='2' fill='none'/%3E%3C/svg%3E" }
        ];

        // Items
        const items = [
            { name: "Health Potion", type: "consumable", effect: "heal", value: 30, image: "https://i.imgur.com/1jQZQ9L.png" },
            { name: "Sword", type: "weapon", effect: "attack", value: 5, image: "https://i.imgur.com/2jQZQ9L.png" },
            { name: "Shield", type: "armor", effect: "defense", value: 5, image: "https://i.imgur.com/0jQZQ9L.png" }
        ];

        // Initialize the game
        function initGame() {
            updateUI();
            generateNewEnemy();
            
            // Add upgrade buttons to party UI
            updatePartyUI();
        }

        // Update all UI elements
        function updateUI() {
            // Update resources
            document.getElementById('gold').textContent = gameState.gold;
            document.getElementById('gems').textContent = gameState.gems;
            document.getElementById('floor').textContent = gameState.floor;
            
            // Update party display
            updatePartyUI();
            
            // Update tavern display
            updateTavernUI();
            
            // Update enemy display
            if (gameState.currentEnemy) {
                document.getElementById('enemy-name').textContent = gameState.currentEnemy.name;
                document.getElementById('enemy-image').src = gameState.currentEnemy.image;
                const healthPercent = (gameState.currentEnemy.health / gameState.currentEnemy.maxHealth) * 100;
                document.getElementById('enemy-health-bar').style.width = `${healthPercent}%`;
                document.getElementById('enemy-health').textContent = `${gameState.currentEnemy.health}/${gameState.currentEnemy.maxHealth}`;
            }
            
            // Update upgrades
            document.getElementById('current-capacity').textContent = gameState.party.length;
            document.getElementById('next-capacity').textContent = gameState.party.length + 5;
        }

        // Update party UI
        function updatePartyUI() {
            const partyContainer = document.getElementById('party-container');
            partyContainer.innerHTML = '';
            
            for (let i = 0; i < gameState.party.length; i++) {
                const slot = document.createElement('div');
                slot.className = 'bg-gray-700 rounded-lg p-1 text-center party-slot';
                slot.dataset.slot = i;
                slot.onclick = () => managePartySlot(i);
                
                if (gameState.party[i]) {
                    const character = gameState.party[i];
                    const healthPercent = (character.health / character.maxHealth) * 100;
                    
                    slot.innerHTML = `
                        <img src="${character.image}" alt="${character.name}" class="w-12 h-12 mx-auto mb-1 pixel-art">
                        <div class="text-xs mb-1">${character.name}</div>
                        <div class="h-1 bg-gray-600 rounded-full mb-1">
                            <div class="h-full bg-green-500 rounded-full progress-bar" style="width: ${healthPercent}%"></div>
                        </div>
                        <div class="text-xs">${character.health}/${character.maxHealth}</div>
                        <button class="mt-1 bg-blue-600 text-white text-xs px-1 py-0.5 rounded upgrade-btn" onclick="showUpgradeMenu(event, ${i})">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                    `;
                    slot.classList.remove('empty-slot');
                } else {
                    slot.innerHTML = `
                        <div class="w-12 h-12 mx-auto mb-1 flex items-center justify-center text-gray-500">
                            <i class="fas fa-plus"></i>
                        </div>
                    `;
                    slot.classList.add('empty-slot');
                }
                
                partyContainer.appendChild(slot);
            }
        }

        // Show upgrade menu for character
        function showUpgradeMenu(event, slotIndex) {
            event.stopPropagation();
            const character = gameState.party[slotIndex];
            if (!character) return;
            
            // Create upgrade menu
            const menu = document.createElement('div');
            menu.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            menu.innerHTML = `
                <div class="bg-gray-800 rounded-lg p-6 w-80">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">${character.name} Upgrades</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-3">
                        <div class="bg-gray-700 rounded-lg p-3">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h4 class="font-bold">Attack Power</h4>
                                    <p class="text-sm text-gray-300">Current: ${character.attack}</p>
                                </div>
                                <button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-lg text-sm" 
                                        onclick="upgradeStat(${slotIndex}, 'attack', 5, 50)">
                                    +5 (50g)
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-gray-700 rounded-lg p-3">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h4 class="font-bold">Defense</h4>
                                    <p class="text-sm text-gray-300">Current: ${character.defense}</p>
                                </div>
                                <button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-lg text-sm" 
                                        onclick="upgradeStat(${slotIndex}, 'defense', 3, 40)">
                                    +3 (40g)
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-gray-700 rounded-lg p-3">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h4 class="font-bold">Hit Points</h4>
                                    <p class="text-sm text-gray-300">Current: ${character.maxHealth}</p>
                                </div>
                                <button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-lg text-sm" 
                                        onclick="upgradeStat(${slotIndex}, 'maxHealth', 20, 60)">
                                    +20 (60g)
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-gray-700 rounded-lg p-3">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h4 class="font-bold">Attack Speed</h4>
                                    <p class="text-sm text-gray-300">Current: ${character.attackSpeed}ms</p>
                                </div>
                                <button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-lg text-sm" 
                                        onclick="upgradeStat(${slotIndex}, 'attackSpeed', -100, 70)">
                                    +100% (70g)
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-gray-700 rounded-lg p-3">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h4 class="font-bold">Dodge Rate</h4>
                                    <p class="text-sm text-gray-300">Current: ${(character.dodgeRate * 100).toFixed(1)}%</p>
                                </div>
                                <button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-lg text-sm" 
                                        onclick="upgradeStat(${slotIndex}, 'dodgeRate', 0.05, 80)">
                                    +5% (80g)
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-gray-700 rounded-lg p-3">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h4 class="font-bold">Critical Chance</h4>
                                    <p class="text-sm text-gray-300">Current: ${(character.critChance * 100).toFixed(1)}%</p>
                                </div>
                                <button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-lg text-sm" 
                                        onclick="upgradeStat(${slotIndex}, 'critChance', 0.05, 90)">
                                    +5% (90g)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(menu);
        }

        // Upgrade character stat
        function upgradeStat(slotIndex, stat, value, cost) {
            const character = gameState.party[slotIndex];
            if (!character) return;
            
            if (gameState.gold >= cost) {
                gameState.gold -= cost;
                
                if (stat === 'maxHealth') {
                    character.maxHealth += value;
                    character.health += value; // Heal when increasing max health
                } else if (stat === 'attackSpeed') {
                    character.attackSpeed = Math.max(200, character.attackSpeed + value);
                } else if (stat === 'dodgeRate' || stat === 'critChance') {
                    character[stat] = Math.min(0.75, character[stat] + value); // Cap at 75%
                } else {
                    character[stat] += value;
                }
                
                addToLog(`Upgraded ${character.name}'s ${stat} for ${cost} gold!`);
                updateUI();
                
                // Close upgrade menu
                const menu = document.querySelector('.fixed');
                if (menu) menu.remove();
            } else {
                addToLog("Not enough gold for this upgrade!");
            }
        }

        // Update tavern UI
        function updateTavernUI() {
            // In a real game, you'd show characters waiting in the tavern
        }

        // Recruit a character
        function recruitCharacter(type) {
            const character = characterTypes[type];
            
            if (gameState.gold >= character.cost) {
                gameState.gold -= character.cost;
                
                // Add to tavern (in a real game, you'd have a tavern with waiting characters)
                // For now, we'll try to add directly to party if there's space
                const emptySlot = gameState.party.findIndex(slot => slot === null);
                
                if (emptySlot !== -1) {
                    // Clone the character to avoid reference issues
                    const newCharacter = JSON.parse(JSON.stringify(character));
                    gameState.party[emptySlot] = newCharacter;
                    addToLog(`Recruited a ${newCharacter.name} to your party!`);
                } else {
                    gameState.tavern.push(JSON.parse(JSON.stringify(character)));
                    addToLog(`Recruited a ${character.name} to the tavern (party full).`);
                }
                
                updateUI();
            } else {
                addToLog("Not enough gold to recruit this character!");
                document.getElementById('tavern-tab').classList.add('shake');
                setTimeout(() => {
                    document.getElementById('tavern-tab').classList.remove('shake');
                }, 500);
            }
        }

        // Toggle auto recruit
        function toggleAutoRecruit() {
            gameState.autoRecruit = !gameState.autoRecruit;
            const btn = document.getElementById('auto-recruit-btn');
            
            if (gameState.autoRecruit) {
                btn.innerHTML = '<i class="fas fa-robot mr-2"></i> Auto-Recruit: On';
                btn.classList.remove('bg-blue-600');
                btn.classList.add('bg-green-600');
                
                // Start auto recruit interval
                gameState.recruitInterval = setInterval(() => {
                    if (gameState.gold >= 50) { // Enough for cheapest character
                        // Randomly recruit a character
                        const types = Object.keys(characterTypes);
                        const randomType = types[Math.floor(Math.random() * types.length)];
                        recruitCharacter(randomType);
                    }
                }, 5000);
            } else {
                btn.innerHTML = '<i class="fas fa-robot mr-2"></i> Auto-Recruit: Off';
                btn.classList.remove('bg-green-600');
                btn.classList.add('bg-blue-600');
                
                // Clear auto recruit interval
                if (gameState.recruitInterval) {
                    clearInterval(gameState.recruitInterval);
                    gameState.recruitInterval = null;
                }
            }
        }

        // Manage party slot
        function managePartySlot(slotIndex) {
            if (gameState.party[slotIndex]) {
                // Character is in this slot - show options (heal, dismiss, etc.)
                const character = gameState.party[slotIndex];
                addToLog(`Selected ${character.name} in slot ${slotIndex + 1}.`);
                
                // In a full game, you'd show a menu with options
            } else {
                // Empty slot - try to fill from tavern
                if (gameState.tavern.length > 0) {
                    gameState.party[slotIndex] = gameState.tavern.shift();
                    addToLog(`Moved character from tavern to party slot ${slotIndex + 1}.`);
                    updateUI();
                } else {
                    addToLog("No characters available in the tavern to recruit.");
                }
            }
        }

        // Generate a new enemy
        function generateNewEnemy() {
            // Scale enemy stats with floor
            const floorModifier = 1 + (gameState.floor - 1) * 0.3;
            
            // Select enemy based on floor
            let enemyIndex = Math.min(Math.floor(gameState.floor / 2), enemyTypes.length - 1);
            const baseEnemy = enemyTypes[enemyIndex];
            
            gameState.currentEnemy = {
                ...baseEnemy,
                health: Math.floor(baseEnemy.health * floorModifier),
                maxHealth: Math.floor(baseEnemy.maxHealth * floorModifier),
                attack: Math.floor(baseEnemy.attack * floorModifier),
                defense: Math.floor(baseEnemy.defense * floorModifier)
            };
            
            updateUI();
        }

        // Start battle
        function startBattle() {
            if (gameState.isBattling) return;
            
            // Check if party has at least one member
            const hasPartyMembers = gameState.party.some(slot => slot !== null && slot.health > 0);
            if (!hasPartyMembers) {
                addToLog("You need at least one alive party member to battle!");
                return;
            }
            
            gameState.isBattling = true;
            const battleBtn = document.getElementById('battle-btn');
            battleBtn.disabled = true;
            battleBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Battling...';
            
            // Start battle loop
            battleLoop();
            
            // If not auto-battling, enable button after one round
            if (!gameState.autoBattle) {
                setTimeout(() => {
                    if (gameState.currentEnemy.health > 0) {
                        endBattle(false, true); // partial end - just enable button
                    }
                }, gameState.battleSpeed);
            }
        }

        // Battle loop
        function battleLoop() {
            if (!gameState.currentEnemy || gameState.currentEnemy.health <= 0) {
                endBattle(true);
                return;
            }
            
            // Check if all party members are dead
            const alivePartyMembers = gameState.party.filter(member => member && member.health > 0);
            if (alivePartyMembers.length === 0) {
                endBattle(false);
                return;
            }
            
            // Medic healing
            for (let i = 0; i < gameState.party.length; i++) {
                const member = gameState.party[i];
                if (member && member.name === "Medic" && member.health > 0) {
                    // Heal random party member
                    const aliveMembers = gameState.party.filter(m => m && m.health > 0);
                    if (aliveMembers.length > 0) {
                        const target = aliveMembers[Math.floor(Math.random() * aliveMembers.length)];
                        const healAmount = Math.floor(target.maxHealth * 0.15); // Heal 15% of max health
                        target.health = Math.min(target.maxHealth, target.health + healAmount);
                        addToLog(`${member.name} heals ${target.name} for ${healAmount} HP!`);
                    }
                }
            }
            
            // Party attacks
            for (let i = 0; i < gameState.party.length; i++) {
                const member = gameState.party[i];
                if (member && member.health > 0) {
                    setTimeout(() => {
                        attackEnemy(member);
                        
                        // Visual feedback
                        const slot = document.querySelector(`.party-slot[data-slot="${i}"]`);
                        if (slot) slot.classList.add('character-attack');
                        setTimeout(() => {
                            if (slot) slot.classList.remove('character-attack');
                        }, 300);
                    }, i * 200); // Stagger attacks for better visibility
                }
            }
            
            // Enemy attacks after party is done
            setTimeout(() => {
                if (gameState.currentEnemy && gameState.currentEnemy.health > 0) {
                    const randomAliveMemberIndex = Math.floor(Math.random() * alivePartyMembers.length);
                    const targetMember = alivePartyMembers[randomAliveMemberIndex];
                    attackPartyMember(targetMember);
                    
                    // Visual feedback
                    document.getElementById('enemy-container').classList.add('enemy-attack');
                    setTimeout(() => {
                        document.getElementById('enemy-container').classList.remove('enemy-attack');
                    }, 300);
                }
                
                // Continue battle if auto-battle is on
                if (gameState.autoBattle && gameState.isBattling) {
                    gameState.battleInterval = setTimeout(battleLoop, gameState.battleSpeed);
                }
            }, gameState.party.length * 200 + 300); // Wait for all party attacks to complete
        }

        // Attack enemy
        function attackEnemy(attacker) {
            if (!gameState.currentEnemy) return;
            
            // Check for dodge
            if (Math.random() < gameState.currentEnemy.dodgeRate) {
                addToLog(`${gameState.currentEnemy.name} dodged ${attacker.name}'s attack!`);
                return;
            }
            
            // Calculate base damage
            let damage = Math.max(1, attacker.attack - gameState.currentEnemy.defense / 2);
            
            // Check for critical hit
            let isCritical = Math.random() < attacker.critChance;
            if (isCritical) {
                damage = Math.floor(damage * 1.5);
            }
            
            gameState.currentEnemy.health -= damage;
            
            // Show damage popup
            showDamagePopup(damage, document.getElementById('enemy-container'), true);
            
            addToLog(`${attacker.name} hits ${gameState.currentEnemy.name} for ${damage} damage!`);
            
            // Check if enemy is defeated
            if (gameState.currentEnemy.health <= 0) {
                gameState.currentEnemy.health = 0;
                addToLog(`${gameState.currentEnemy.name} was defeated!`);
                
                // Award gold
                const goldEarned = Math.floor(20 + Math.random() * 30) * (1 + (gameState.upgrades.gold.level - 1) * 0.2);
                gameState.gold += Math.floor(goldEarned);
                addToLog(`Earned ${Math.floor(goldEarned)} gold!`);
                
                // Chance to drop item
                if (Math.random() < 0.3) {
                    const randomItem = items[Math.floor(Math.random() * items.length)];
                    gameState.inventory.push(randomItem);
                    addToLog(`Found a ${randomItem.name}!`);
                }
                
                // Increase floor
                gameState.floor++;
                
                // Generate new enemy
                setTimeout(() => {
                    generateNewEnemy();
                    updateUI();
                }, 500);
            }
            
            updateUI();
        }

        // Attack party member
        function attackPartyMember(member) {
            if (!gameState.currentEnemy) return;
            
            const damage = Math.max(1, gameState.currentEnemy.attack - member.defense / 2);
            member.health -= damage;
            
            // Show damage popup
            const slotIndex = gameState.party.findIndex(m => m === member);
            const slot = document.querySelector(`.party-slot[data-slot="${slotIndex}"]`);
            if (slot) showDamagePopup(damage, slot, false);
            
            addToLog(`${gameState.currentEnemy.name} hits ${member.name} for ${damage} damage!`);
            
            // Check if member is defeated
            if (member.health <= 0) {
                member.health = 0;
                addToLog(`${member.name} was defeated!`);
                
                // Keep dead character in party but set health to 0
                member.health = 0;
                updateUI();
            }
            
            updateUI();
        }

        // Show damage popup
        function showDamagePopup(amount, parentElement, isPlayerAttack) {
            const popup = document.createElement('div');
            popup.className = 'damage-popup';
            popup.textContent = `-${amount}`;
            popup.style.color = isPlayerAttack ? 'red' : 'white';
            
            // Position randomly within the parent element
            const rect = parentElement.getBoundingClientRect();
            const x = Math.random() * (rect.width - 30);
            const y = Math.random() * (rect.height - 20);
            
            popup.style.left = `${x}px`;
            popup.style.top = `${y}px`;
            
            parentElement.appendChild(popup);
            
            // Remove after animation
            setTimeout(() => {
                popup.remove();
            }, 1000);
        }

        // End battle
        function endBattle(victory, partial = false) {
            gameState.isBattling = false;
            const battleBtn = document.getElementById('battle-btn');
            
            if (victory) {
                addToLog("Battle won! Preparing for next floor...");
            } else if (!partial) {
                addToLog("Party defeated! Returning to tavern...");
                
                // Reset to first enemy type
                gameState.floor = 1;
                
                // Reset party health
                gameState.party.forEach(member => {
                    if (member) {
                        member.health = member.maxHealth;
                    }
                });
                
                generateNewEnemy();
            }
            
            if (!partial) {
                // Clear any ongoing battle intervals
                if (gameState.battleInterval) {
                    clearInterval(gameState.battleInterval);
                    gameState.battleInterval = null;
                }
            }
            
            battleBtn.disabled = false;
            battleBtn.innerHTML = '<i class="fas fa-play mr-1"></i> Start Battle';
            
            updateUI();
        }

        // Toggle auto battle
        function toggleAutoBattle() {
            gameState.autoBattle = !gameState.autoBattle;
            const btn = document.getElementById('auto-battle-btn');
            
            if (gameState.autoBattle) {
                btn.innerHTML = '<i class="fas fa-robot mr-1"></i> Auto: On';
                btn.classList.remove('bg-purple-600');
                btn.classList.add('bg-green-600');
                
                // Start auto battle if not already battling
                if (!gameState.isBattling) {
                    startBattle();
                }
            } else {
                btn.innerHTML = '<i class="fas fa-robot mr-1"></i> Auto: Off';
                btn.classList.remove('bg-green-600');
                btn.classList.add('bg-purple-600');
            }
        }

        // Buy upgrade
        function buyUpgrade(type) {
            const upgrade = gameState.upgrades[type];
            
            if (gameState.gold >= upgrade.cost) {
                gameState.gold -= upgrade.cost;
                upgrade.level++;
                upgrade.cost = Math.floor(upgrade.cost * 1.5);
                
                // Apply upgrade effects
                if (type === 'speed') {
                    gameState.battleSpeed = Math.max(200, 1000 - (upgrade.level - 1) * 200);
                }
                
                addToLog(`Purchased ${type} upgrade (now level ${upgrade.level})!`);
                updateUI();
            } else {
                addToLog("Not enough gold for this upgrade!");
                document.getElementById('upgrades-tab').classList.add('shake');
                setTimeout(() => {
                    document.getElementById('upgrades-tab').classList.remove('shake');
                }, 500);
            }
        }

        // Add message to battle log
        function addToLog(message) {
            const logContent = document.getElementById('log-content');
            const entry = document.createElement('div');
            entry.className = 'text-gray-300';
            entry.textContent = message;
            logContent.appendChild(entry);
            
            // Auto-scroll to bottom
            logContent.scrollTop = logContent.scrollHeight;
            
            // Show log if hidden
            document.getElementById('battle-log').classList.remove('hidden');
        }

        // Toggle battle log visibility
        function toggleBattleLog() {
            const log = document.getElementById('battle-log');
            log.classList.toggle('hidden');
        }

        // Initialize the game when page loads
        window.onload = initGame;
    </script>
</body>
</html>
